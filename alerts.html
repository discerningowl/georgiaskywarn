<!--
  ──────────────────────────────────────────────────────────────
  File:   alerts.html
  Author: Jack Parks (KQ4JP) <kq4jp@pm.me>
  Purpose: Dedicated page for Active Watches & Warnings from NWS Atlanta (FFC).
           Maintains consistent look and feel with index.html using shared stylesheet.
  Change-log:
    • 2025-11-09 – Extracted alerts section and script from index.html.
  ──────────────────────────────────────────────────────────────
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Metadata for character encoding and responsive viewport -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Page title -->
  <title>Georgia SKYWARN - Active Weather Alerts</title>

  <!-- Meta description for SEO -->
  <meta name="description" content="Real-time severe weather alerts, warnings, and watches for North and Central Georgia from NWS Peachtree City. Monitor active tornado, thunderstorm, flood, and winter weather alerts.">
  <meta name="keywords" content="Georgia weather alerts, NWS warnings, severe weather, tornado warning, flood watch, SKYWARN alerts, NWS Peachtree City">
  <meta name="author" content="Jack Parks (KQ4JP)">

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.weather.gov; font-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'">

  <!-- Additional Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <!-- DNS prefetch and preconnect for NWS API -->
  <link rel="preconnect" href="https://api.weather.gov">
  <link rel="dns-prefetch" href="https://api.weather.gov">

  <!-- Open Graph meta tags for social media -->
  <meta property="og:title" content="Georgia SKYWARN - Active Weather Alerts">
  <meta property="og:description" content="Real-time severe weather alerts, warnings, and watches for North and Central Georgia from NWS Peachtree City.">
  <meta property="og:image" content="https://georgiaskywarn.com/nws.gif">
  <meta property="og:url" content="https://georgiaskywarn.com/alerts.html">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Georgia SKYWARN">

  <!-- Twitter Card meta tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Georgia SKYWARN - Active Weather Alerts">
  <meta name="twitter:description" content="Real-time severe weather alerts from NWS Peachtree City for North and Central Georgia.">
  <meta name="twitter:image" content="https://georgiaskywarn.com/nws.gif">

  <!-- External shared stylesheet (relative URL) -->
  <link rel="stylesheet" href="style.css">

  <!-- Basic favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">

</head>

<body>
  <!-- Site header with title (ARIA landmark) -->
  <header class="site-header" role="banner" id="topheader">
    <h1 class="site-title">NWS Atlanta Alerts</h1>
    <h2 class="site-subtitle">Active Alerts for the NWS Atlanta Area</h2>
  </header>

  <!-- Site-wide navigation (colored buttons) -->
  <nav class="site-nav" role="navigation" aria-label="Site navigation">
    <button class="nav-toggle" aria-controls="site-nav-list"
            aria-expanded="false" aria-label="Toggle site menu">☰ SITE</button>
    <ul id="site-nav-list" class="nav-list">
      <li><a href="index.html">← Back to Georgia SKYWARN</a></li>
      <li><a href="repeaters.html" class="nav-btn-link">SKYWARN Repeaters</a></li>
      <li><a href="wx4ptc.html" class="nav-btn-link">WX4PTC Page</a></li>
      <li><a href="nwsffclinks.html" class="nav-btn-link">Useful NWS Links</a></li>
      <li><a href="about.html" class="nav-btn-link">About</a></li>
  </nav>

  <!-- Page navigation not needed for alerts page - it's single purpose -->

  <!-- Main content area (ARIA landmark) -->
  <main class="site-main" role="main">

    <!-- Active Alerts Section (added based on script reference) -->
    <section class="card alert-card" id="alertscard">
      <header class="card-header card-header--red">
        <h2 class="card-title">Active Area Watches & Warnings & Alerts (NWS Atlanta - FFC)</h2>
      </header>
      <div class="card-body">
        <aside class="callout warning">
        	<p class="center">
        	<strong>Warnings</strong> will be red, <strong>Watches</strong> are in orange, and <strong>Alerts</strong> are in teal.
        	</p>
        </aside>
        <div id="alerts-loading" class="skeleton-loader" aria-label="Loading active alerts"></div>
        <div id="alerts-container"></div>
      </div>
    </section>

  </main>

  <!-- Site footer - calls on footer.html via script-->
  <div id="footer-placeholder"></div>

  <!-- NWS Alerts script - All FFC Watches & Warnings (Red=Warning, Orange=Watch) -->
  <script>
    (async () => {
      const container = document.getElementById('alerts-container');
      const loading = document.getElementById('alerts-loading');
      const USER_AGENT = 'GeorgiaSKYWARN-Site (kq4jp@pm.me)';
      const CACHE_KEY = 'ffc-all-watches-warnings';
      const CACHE_TTL = 5 * 60 * 1000; // 5 minutes
  
      // Exact FFC zones: GAZ001 to GAZ118
      const FFC_ZONES = Array.from({ length: 118 }, (_, i) => 
        `GAZ${String(i + 1).padStart(3, '0')}`
      ).join(',');
  
      const hide = el => el.style.display = 'none';
      const show = (el, html = '') => { el.innerHTML = html; el.style.display = 'block'; };
  
      const getCache = () => {
        const c = localStorage.getItem(CACHE_KEY);
        if (!c) return null;
        const { data, ts } = JSON.parse(c);
        return Date.now() - ts <= CACHE_TTL ? data : null;
      };
  
      const setCache = data => localStorage.setItem(CACHE_KEY, JSON.stringify({ data, ts: Date.now() }));
  
      const fetchAlerts = async (retries = 3) => {
        const cached = getCache();
        if (cached) return cached;

        for (let i = 0; i < retries; i++) {
          try {
            const url = `https://api.weather.gov/alerts/active?zone=${FFC_ZONES}`;
            const resp = await fetch(url, {
              headers: { 'User-Agent': USER_AGENT },
              signal: AbortSignal.timeout(10000) // 10 second timeout
            });

            if (resp.status === 503 || resp.status === 429) {
              // Service unavailable or rate limited - retry
              if (i < retries - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                continue;
              }
            }

            if (!resp.ok) throw new Error(`NWS API error: ${resp.status}`);

            const json = await resp.json();
            setCache(json);
            return json;
          } catch (err) {
            if (i === retries - 1) throw err; // Last retry failed
            await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
          }
        }
      };
  
      const render = data => {
        const features = (data.features || []).filter(f => {
          const p = f.properties;
          // Use 'senderName' to identify FFC-issued alerts
          return p.senderName && p.senderName.includes('NWS Peachtree City');
        });

        const lastUpdate = new Date().toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const refreshIndicator = `
          <div class="alert-refresh-indicator">
            <span class="pulse"></span>
            Auto-refreshing every 5 minutes
          </div>
          <p class="alert-timestamp">Last updated: ${lastUpdate}</p>
        `;

        if (features.length === 0) {
          return refreshIndicator + `<p class="no-alerts center"><strong>No active watches or warnings in NWS Atlanta (FFC) area.</strong></p>`;
        }
  
        return refreshIndicator + features.map(f => {
          const p = f.properties;
          const isWarning = p.event?.toLowerCase().includes('warning');
          const isWatch = p.event?.toLowerCase().includes('watch');
          const type = isWarning ? 'WARNING' : isWatch ? 'WATCH' : 'ALERT';
          const colorClass = isWarning ? 'alert-warning' : isWatch ? 'alert-watch' : 'alert-other';

          const desc = (p.description || '').replace(/\n/g, '<br>');
          const instr = (p.instruction || '').replace(/\n/g, '<br>');

          return `
            <div class="alert-item ${colorClass}">
              <div class="alert-header">${p.headline || p.event} – <strong>${type}</strong></div>
              <div class="alert-description">${desc}</div>
              ${instr ? `<hr><div class="alert-description"><strong>Instructions:</strong> ${instr}</div>` : ''}
              <small><strong>Areas:</strong> ${p.areaDesc} | <strong>Expires:</strong> ${new Date(p.expires).toLocaleString()}</small>
            </div>`;
        }).join('');
      };
  
      try {
        const data = await fetchAlerts();
        hide(loading);
        show(container, render(data));

        // Background refresh every 5 minutes (respects cache)
        setInterval(async () => {
          try {
            const freshData = await fetchAlerts();
            show(container, render(freshData));
          } catch (err) {
            console.error('Background refresh failed:', err);
            // Don't clear existing alerts - keep showing cached data
          }
        }, 5 * 60 * 1000);
      } catch (e) {
        hide(loading);
        const errorMsg = `
          <div class="callout warning">
            <p class="center">
              <strong>Unable to load alerts at this time.</strong><br>
              The National Weather Service API may be temporarily unavailable.<br>
              Please check <a href="https://www.weather.gov/ffc/" target="_blank" rel="noopener noreferrer">NWS Atlanta</a> directly for current alerts.
            </p>
          </div>
        `;
        show(container, errorMsg);
        console.error('Alert fetch error:', e);
      }
    })();
  </script>

<!-- Back to Top Button -->
<button class="back-to-top" aria-label="Back to top" title="Back to top">
  ↑
</button>

<!-- Consolidated JavaScript -->
<script src="scripts.js"></script>

</body>
</html>